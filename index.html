<!DOCTYPE html>
<html lang="ja" class="morning">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>æœæ”¯åº¦</title>

<link rel="manifest" href="/manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png"> 

<style>
:root{
  /* åŸºæœ¬é…è‰² */
  --bg1:#1b2630;
  --bg2:#2b3845;
  --fg:#f5f7fa;
  --muted:#b6c2cc;
  --panel:rgba(255,255,255,.12);
  --panel-br:rgba(255,255,255,.25);
  --warm1:#ffd98e;
  --warm2:#ffb965;
  --ok:#60d9a3;
  --warn:#ffb65f;
  --danger:#ff6b6b;
  --panel-bg: rgba(255,255,255,.08);
  --panel-line: rgba(255,255,255,.15);
  --block-bg: rgba(255,255,255,.05);
  --block-line: rgba(255,255,255,.12); 
  --input-bg: #0b1621;
  --input-fg: var(--fg);
  --input-br: rgba(255,255,255,.15);
  --btn-bg: rgba(255,255,255,.06);
  --btn-line: rgba(255,255,255,.18);
  --progress-bg: rgba(255,255,255,.08);
  --mask-bg: rgba(0,0,0,.35);
  --drawer-bg: rgba(20,28,40,.95);
  --drawer-br: rgba(255,255,255,.18);
  --toast-bg:#253448;
  --toast-fg:#ff7b6b;
  --toast-br:rgba(255,123,107,.3);
  --toast-shadow:0 6px 18px rgba(255,123,107,.18);
}

/* ãƒ•ã‚©ãƒ³ãƒˆæŒ‡å®šï¼šã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚©ãƒ³ãƒˆå„ªå…ˆã§å¯èª­æ€§ç¢ºä¿ */
body{
  margin:0;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--fg);
  font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
  height:100svh; overflow:hidden; transition:background none;
}

/* çŠ¶æ…‹åˆ¥èƒŒæ™¯ */
body.active{
  background: radial-gradient(800px 600px at 50% 0%, rgba(255,220,150,.25), transparent 60%),
              linear-gradient(180deg,#24303a,#1b2630);
}
body.reward{
  background: radial-gradient(900px 700px at 50% 0%, rgba(50, 150, 255, .35), transparent 60%),
              linear-gradient(180deg, #13253b, #0d1722);
}
body.delay{
  background: radial-gradient(1200px 800px at 50% 0%, rgba(200,60,60,.25), transparent 60%),
              linear-gradient(180deg,#3a1a1a,#1b0a0a);
}

*{box-sizing:border-box} html,body{height:100%}

.app{display:grid;grid-template-rows:auto 1fr auto;gap:10px;height:100%;padding:12px;max-width:720px;margin:0 auto}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
.header{display:flex;align-items:center;justify-content:space-between}
.brand{font-weight:700;letter-spacing:.06em}
.modeBtn{appearance:none;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:var(--fg);
  padding:8px 10px;border-radius:12px;cursor:pointer}

/* ä¸Šæ®µ */
.main{display:grid;grid-template-rows:auto 1fr;gap:10px;min-height:0}
.top{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.panel{background:var(--panel);border:1px solid var(--panel-br);border-radius:14px;padding:12px;backdrop-filter:blur(6px)}

/* é€šå¸¸ã®ãƒ–ãƒ­ãƒƒã‚¯ */
.block{
  background: var(--block-bg);
  border: 1px solid var(--block-line);
  border-radius: 12px; padding:10px;
}

/* â˜… ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºç”¨ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆä¸­å¤®æƒãˆãƒ»ã¯ã¿å‡ºã—é˜²æ­¢ï¼‰ */
.panel:nth-child(2) .block {
  display: flex;
  flex-direction: column;
  align-items: center;    
  justify-content: center;
  overflow: hidden;       
  padding: 10px; 
}

/* ãƒ†ã‚­ã‚¹ãƒˆãƒ»è£…é£¾ */
.k { font-size: .8rem; color: var(--muted); }
.v { font-variant-numeric: tabular-nums; font-size: 1.2rem; margin-top: 4px; }
.big{ font-size:1.8rem; }
.big2{ font-size:2.8rem; } /* åŸºæœ¬ã‚µã‚¤ã‚ºï¼ˆç¶™æ‰¿ç”¨ï¼‰ */

/* ---------------------------------------------------- */
/* â° æ±ºå®šç‰ˆï¼šãƒ‘ãƒãƒ«ä¼¸ç¸®ã¨ã‚ºãƒ¬ã‚’æ ¹çµ¶ã™ã‚‹ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
/* ---------------------------------------------------- */
#remain {
  /* ãƒ‘ãƒãƒ«ã®ä¼¸ç¸®ã‚’é˜²ããŸã‚ã€ååˆ†ãªå›ºå®šå¹…ã‚’ä¸ãˆã‚‹ */
  width: 260px;
  max-width: 100%; 

  /* CSS Gridã§ã€Œ1:1ã€ã®æ¯”ç‡ã‚’ä½œã‚‹ï¼šå·¦(1fr) : ã‚³ãƒ­ãƒ³(auto) : å³(1fr) */
  /* ã“ã‚Œã«ã‚ˆã‚Šã€å·¦å³ã®ä¸­èº«ãŒä½•ã§ã‚ã‚Œã€ã‚³ãƒ­ãƒ³ã¯å¸¸ã«ã€Œä¸­å¿ƒã€ã«æ¥ã‚‹ */
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: baseline;
  
  /* æ•°å­—ã®ç­‰å¹…è¨­å®š */
  font-feature-settings: "tnum"; 
  font-variant-numeric: tabular-nums; 
  
  /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’æ˜ç¤º */
  font-size: 2.8rem;
}

/* åˆ†ã‚¨ãƒªã‚¢ï¼šå³æƒãˆ */
.min-part {
  text-align: right; 
  padding-right: 2px; /* ã‚³ãƒ­ãƒ³ã¨ã®éš™é–“èª¿æ•´ */
  white-space: nowrap;
}

/* ç§’ã‚¨ãƒªã‚¢ï¼šå·¦æƒãˆ */
.sec-part {
  text-align: left; 
  padding-left: 2px; /* ã‚³ãƒ­ãƒ³ã¨ã®éš™é–“èª¿æ•´ */
  white-space: nowrap;
}

/* ğŸ“± ç”»é¢å¹…ãŒæ¥µç«¯ã«ç‹­ã„ç«¯æœ«å‘ã‘ã®å¾®èª¿æ•´ */
@media (max-width: 380px) { 
  #remain {
    font-size: 2.6rem; 
    width: 240px; 
  }
}
/* ---------------------------------------------------- */


.badge{padding:4px 8px;border-radius:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18)}
.icon { appearance: none; border: 1px solid var(--btn-line); background: var(--btn-bg); color: var(--fg); padding: 4px 6px; border-radius: 10px; cursor: pointer; margin-left: 6px; }

/* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
.progress{ height:8px; background: var(--progress-bg); border-radius:999px; overflow:hidden }
.progress > div { height: 100%; background: linear-gradient(90deg, var(--warm1), var(--warm2)); width: 0%; }

/* çŠ¶æ…‹è‰² */
.ok { color: var(--ok); }
.warn { color: var(--warn); }
.danger { color: var(--danger); }

/* ä¸­æ®µï¼šãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ */
.listPanel{min-height:0;display:grid;grid-template-rows:auto 1fr auto;gap:8px}
.listHead{display:flex;justify-content:space-between;align-items:center}
.list{display:flex;flex-direction:column;gap:8px;overflow:auto;padding-top:6px}
.item{ display:flex;gap:10px;align-items:center; background: var(--panel-bg); border:1px solid var(--panel-line); border-radius:12px;padding:8px}
.item input[type="checkbox"]{width:20px;height:20px}
.item input[type="text"] {flex:1;min-width:0; background: var(--input-bg); border:1px solid var(--input-br); color:var(--input-fg); border-radius:10px;padding:8px}
.iBtn{ background: var(--btn-bg); border: 1px solid var(--btn-line); color: var(--fg); padding:6px 8px;border-radius:10px }
.resetWrap{display:flex;justify-content:flex-end}

/* ãƒ•ãƒƒã‚¿ãƒ¼ */
.footer{display:flex;align-items:center;justify-content:center;gap:10px;padding-bottom:calc(env(safe-area-inset-bottom,0) + 4px)}
.btn{appearance:none;border:none;border-radius:12px;padding:8px 20px;font-weight:700;cursor:pointer}
.btn.pri{background:linear-gradient(180deg,var(--warm1),var(--warm2));color:#28150a;box-shadow:0 8px 20px rgba(255,170,90,.35)}
.btn.gh { position: absolute; right: 16px; bottom: calc(12px + env(safe-area-inset-bottom, 0)); background: rgba(255,255,255,.08); color: var(--fg); border: 1px solid rgba(255,255,255,.18); padding: 8px 12px; border-radius: 12px; transform: translateY(-4px); z-index: 10; }

/* ãƒ‰ãƒ­ãƒ¯ãƒ¼ï¼ˆä¸‹ã‹ã‚‰ï¼‰ */
.drawerMask { position: fixed; inset: 0; background: var(--mask-bg); backdrop-filter: blur(2px); opacity: 0; pointer-events: none; transition: .2s; z-index: 40; }
.drawer { position: fixed; left: 0; right: 0; bottom: -70vh; height: 60vh; background: var(--drawer-bg); border-top: 1px solid var(--drawer-br); border-radius: 16px 16px 0 0; padding: 14px; transition: .25s; box-shadow: 0 -12px 28px rgba(0,0,0,.35); display: flex; flex-direction: column; gap: 10px; z-index: 41; }
body.show-drawer .drawerMask { opacity: 1; pointer-events: auto; }
body.show-drawer .drawer { bottom: 0; }
.row { display: flex; gap: 8px; align-items: center; }

/* ãƒ‰ãƒ­ãƒ¯ãƒ¼å†…ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚°ãƒªãƒƒãƒ‰ */
.drawer .block { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
@media (max-width: 500px) { .drawer .block { grid-template-columns: 1fr; } }

input[type="time"], input[type="text"] { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--input-br); background: var(--input-bg); color: var(--input-fg); }
label { color: var(--muted); font-size: .9rem; }

/* ãƒˆãƒ¼ã‚¹ãƒˆ */
.toast{ position:fixed; left:20px; bottom:calc(40px + env(safe-area-inset-bottom,0)); max-width:min(80vw,420px); background: var(--toast-bg); color: var(--toast-fg); border: 1px solid var(--toast-br); box-shadow: var(--toast-shadow); font-weight: 600; padding:12px 14px; border-radius:12px; opacity:0; pointer-events:none; transition:opacity .4s, transform .4s; transform:translateX(-100px); z-index:50; }
.toast.show{opacity:1;transform:translateX(0)}

/* æ¼”å‡ºç”¨Canvas */
#lightCanvas { position: fixed; top: 0; left: 0; z-index: 1000; pointer-events: none; opacity: 0; transition: opacity 1.5s ease; }
body.reward #lightCanvas { opacity: 0.8; }
body.reward #timerPanel, body.reward #listPanel, body.reward #actionsPanel { opacity: 0.6; transition: opacity 0.8s ease; }

</style>
</head>
<body>

<canvas id="lightCanvas"></canvas>

<div class="app">
  <div class="header">
    <div class="brand">æœå â€” æ”¯åº¦</div>
    <button id="modeToggle" class="modeBtn" title="ãƒ©ãƒ³ãƒ€ãƒ ç™ºè©±">ğŸ’¬</button>
  </div>

  <div class="main">
    <div class="top">
      <div class="panel" id="timerPanel">
        <div class="block">
          <div class="k">ç¾åœ¨</div>
          <div class="v big" id="curTime">--:--:--</div>
        </div>
        <div class="block" style="margin-top:8px">
          <div class="k">å‡ºç™º <button id="editDep" class="icon" title="å‡ºç™ºæ™‚åˆ»ã‚’ç·¨é›†">âš™</button></div>
          <div class="v big" id="depLabel">--:--</div>
        </div>
      </div>
      <div class="panel">
        <div class="block">
          <div class="k">æ®‹ã‚Š</div>
          <div id="remain">
             <span class="min-part">--</span>:<span class="sec-part">--</span>
          </div>
          <div class="progress" style="margin-top:8px"><div id="pbar"></div></div>
          <div class="k" style="margin-top:8px">å®Œäº†ç›®æ¨™ï¼š<span id="goalTime">--:--</span></div>
        </div>
      </div>
    </div>

    <div class="panel listPanel" id="listPanel">
      <div class="listHead">
        <span class="badge">æ”¯åº¦é …ç›®</span>
        <div class="row">
          <input id="newItem" type="text" placeholder="è¿½åŠ ï¼ˆä¾‹ï¼šé¡”ã‚’æ´—ã†ï¼‰" style="width:56vw">
          <button id="addBtn" class="iBtn">è¿½åŠ </button>
        </div>
      </div>
      <div id="list" class="list"></div>
      <div class="resetWrap">
        <button id="resetBtn" class="iBtn">ãƒã‚§ãƒƒã‚¯è§£é™¤</button>
      </div>
    </div>
  </div>

  <div class="footer" id="footerActions"></div>
  <button id="gear" class="btn gh" title="è¨­å®š">è¨­å®š</button>
</div>

<div id="toast" class="toast">â€¦</div>

<div id="mask" class="drawerMask"></div>
<aside id="drawer" class="drawer">
  <div class="row" style="justify-content:space-between">
    <strong>è¨­å®š</strong>
    <button id="closeDr" class="icon">âœ•</button>
  </div>
  <div class="block">
    <div><label>å‡ºç™ºæ™‚åˆ»</label><input id="depTime" type="time"></div>
    <div><label>å£°æ›ã‘ï¼ˆåˆ†å‰ï¼‰</label><input id="cues" type="text" placeholder="30,15,5"></div>
  </div>
  <div><button id="saveSet" class="btn pri" style="width:100%">ä¿å­˜</button></div>
</aside>

<script>
"use strict";

/* ===== èªè¨¼ (ä¸è¦ãªã‚‰å‰Šé™¤) ===== */
const SECRET_KEY = "1122"; 
document.addEventListener('DOMContentLoaded', function() {
  // const enteredKey = prompt("èªè¨¼ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
  // if (enteredKey !== SECRET_KEY) { document.body.innerHTML = "<h1>æ‹’å¦</h1>"; throw new Error("ä¸­æ­¢"); }
  console.log("Started.");
});

/* ===== util ===== */
const $=q=>document.querySelector(q);
const pad=n=>String(n).padStart(2,'0');
const fmtHMS=d=>`${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
const fmtHM=d=>`${pad(d.getHours())}:${pad(d.getMinutes())}`;
function parseHM(str){const m=/^(\d{1,2}):(\d{2})$/.exec(str||""); if(!m)return null; const h=+m[1],mi=+m[2]; if(h>23||mi>59)return null; return {h,mi};}
function toHM(h,m){return `${pad(h)}:${pad(m)}`;}
window.pick = function(a) { return a[Math.floor(Math.random() * a.length)] };

/* ===== Audio System (Cleaned) ===== */
let actx=null, master=null;

// åŒæœŸåˆæœŸåŒ–ï¼ˆã‚¿ã‚¤ãƒãƒ¼ã‹ã‚‰ã®å‘¼ã³å‡ºã—ç”¨ï¼‰
function audioInit(){ 
  if(actx) return;
  actx=new (window.AudioContext||window.webkitAudioContext)(); 
  master=actx.createGain(); 
  master.gain.value=.25; 
  master.connect(actx.destination); 
}

// éåŒæœŸå†é–‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚¤ãƒ™ãƒ³ãƒˆç”¨ï¼‰
async function audioInitAndResume(){ 
  audioInit();
  if(actx.state === 'suspended'){
    await actx.resume().catch(e=>console.error("Resume failed:",e));
  }
}

function tone(freq=440,dur=.25,vol=.2){ 
  if(!actx) return; 
  const t=actx.currentTime,o=actx.createOscillator(),g=actx.createGain(); 
  o.type="sine"; o.frequency.value=freq; 
  g.gain.setValueAtTime(0.0001,t); 
  g.gain.exponentialRampToValueAtTime(vol,t+.01); 
  g.gain.exponentialRampToValueAtTime(0.0001,t+dur); 
  o.connect(g).connect(master); 
  o.start(t); o.stop(t+dur+.02); 
}

function chime(){ tone(1320,.35,.18); setTimeout(()=>tone(1760,.28,.12),0); }
function alarm(){ for(let i=0;i<3;i++) setTimeout(()=>{ tone(880,.22,.40); setTimeout(()=>tone(1320,.28,.35),120); }, i*420); }

/* ã”è¤’ç¾ã‚µã‚¦ãƒ³ãƒ‰ (ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ä¿®æ­£ç‰ˆ) */
function rewardSoundB(){
  if(!actx) return;
  const t = actx.currentTime;
  const localGain = actx.createGain();
  localGain.gain.setValueAtTime(0.3, t);
  localGain.connect(master);

  const notes = [440, 554, 659, 880];
  let delay = 0;
  const duration = 0.08;
  const interval = 200;

  for (let i = 0; i < notes.length; i++) {
    const freq = notes[i];
    setTimeout(() => { 
      const o = actx.createOscillator();
      const g = actx.createGain(); // å€‹åˆ¥ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰
      o.type = 'sine'; 
      o.frequency.setValueAtTime(freq, actx.currentTime);
      
      // o -> g -> localGain -> master
      o.connect(g).connect(localGain); 
      
      const now = actx.currentTime;
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(1.0, now + .01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + duration + 0.05);
      
      o.start(now);
      o.stop(now + duration + 0.1);
    }, delay);
    delay += interval;
  }
  setTimeout(() => tone(1320, .5, .8), 850);
}


/* ===== messages ===== */
const messages={
  random:["è‰¯ã„æµã‚Œã ã€‚","ãµã‚€ã€ã¾ã ã¼ã‚“ã‚„ã‚Šã—ã¦ã„ã‚‹ãªã€‚","ãã®èª¿å­ã ã€æ‰‹ã‚’æ­¢ã‚ã‚‹ãªã€‚","â€¦ã‚„ã£ã¨å‹•ãå‡ºã—ãŸã‹ã€‚","å¸¸ã«ä¸‰æ‰‹å…ˆã‚’è€ƒãˆã‚ã€‚","è¿·ã£ã¦ã„ã‚‹ã‚ˆã†ã ãªã€‚è¦šæ‚Ÿã‚’æ±ºã‚ã‚ˆã€‚","æ‰‹éš›ã¯æ‚ªããªã„ã€‚ã ãŒéš™ã¯ã‚ã‚‹ã€‚","ç„¡é§„ã§ã¯ãªã„ã‹ï¼Ÿ","ã¾ã ä½™è£•ãŒã‚ã‚‹ã‚ˆã†ã ãªã€‚","â€¦æ‰‹ãŒæ­¢ã¾ã£ã¦ã„ã‚‹ãã€‚","æ€ ã‘ã¦ã¯ã„ã¾ã„ãªã€‚","åˆ»ã¯å®¹èµ¦ãªãéãã‚‹ãã€‚","ç§ã‚‚è¦‹ã¦ã„ã‚‹ã€‚","å…ˆèª­ã¿ã‚’æ€ ã‚‹ãªã€‚","é€²æ—ã¯ã©ã†ã ã€‚","ã“ã®çŠ¶æ³ã§ä¼‘ã‚€ã¤ã‚‚ã‚Šã‹ï¼Ÿ","æœ€å¾Œã¾ã§æ°—ã‚’æŠœããªã€‚","æ˜¨å¤œã¯çœ ã‚ŒãŸã®ã‹ï¼Ÿ","ä»Šæ—¥ã®å¤©æ°—ã¯å¦‚ä½•ã ã€‚","ä½•ã‹è€ƒãˆäº‹ã‚’ã—ã¦ã„ã‚‹ã‚ˆã†ã ãªã€‚","è·ã¯æ—¢ã«æƒãˆã¦ã„ã‚‹ã‹ã€‚","ç¨‹ç„¡ãå‡ºç«‹ã ã€‚","æ°—åˆãŒè¦‹ãˆã¦ããŸãªã€‚","é…ã‚Œã¯ä»˜ã‘å…¥ã‚‹éš™ã¨ãªã‚‹ã€‚","è¦šæ‚Ÿã¯ã‚ˆã„ã‹ï¼Ÿ","æ¯ã‚’æ·±ãå¸ãˆã€‚","ã¾ãšã¯ãã‚Œã§è‰¯ã—ã€‚","å®‰å µã§ãã‚‹ã ã‚ã†ã€‚","ç„¦ã‚‹ã“ã¨ã¯ãªã„ã€‚","è‡ªåˆ†ã§æ±ºã‚ãŸæ™‚é–“ã‚’é€²ã‚“ã§ã„ã‚‹ã€‚","å¿ƒã‚‚ä½“ã‚‚æ•´ãˆã‚ˆã€‚","å°ã•ãªå‹åˆ©ã‚’æ•°ãˆã‚ã€‚","æ˜æ—¥ã®è‡ªä¿¡ã«ã¤ãªãŒã‚‹ã ã‚ã†ã€‚","è–¬ã¯é£²ã‚“ã ã‹ï¼Ÿ","ã‚„ã‚‹ã‹ã©ã†ã‹ã ã‘ã ã€‚","ä»Šæ—¥ã‚‚ä¹—ã‚Šè¶Šãˆã‚‰ã‚Œã‚‹ã€‚","ä»•çµ„ã¿ã‚’æ•´ãˆã‚‹ã“ã¨ãŒé‡è¦ã ã€‚","è‡ªå‹•åŒ–ã§é€²ã‚ã‚‹ã»ã†ãŒã‚ˆã„ã€‚","æ‰‹é †ã‚’ä¿¡ã˜ã‚ã€‚","è„³ã®èªçŸ¥çš„ãªèª¤ä½œå‹•ã ã€‚","è„³ã«è€ƒãˆã•ã›ãªã„ã“ã¨ã ã€‚","è„³ãŒç”Ÿãå»¶ã³ã‚‹ãŸã‚ã«é®é™åŒ–ã—ã¦ã„ã‚‹ã€‚","å›è·¯ãŒå£Šã‚ŒãŸã®ã§ã¯ãªã„ã€‚","ä»•çµ„ã¿ãŒå¿…è¦ã ã€‚","ã‚‚ã†å‹•ã„ã¦ã„ã‚‹ã€‚","å¿ƒã®é˜²è¡›ã ã€‚","ç§ãŒãã†ã§ã¯ãªã„ã¨å‘Šã’ã‚ˆã†ã€‚","æˆ»ã£ã¦ããŸã®ã ãªã€‚","ä¸€æ—¥ãšã¤æ­©ã„ã¦ã„ãã€‚","ç„¡äº‹ã«éã”ã™ã“ã¨ã‚’é¡˜ã£ã¦ã„ã‚‹ã€‚","ç§ã®è¨€è‘‰ãŒå¥‘æ©Ÿã¨ãªã‚Œã°ã‚ˆã„ã®ã ãŒã€‚"],
};
const rewardMessages = {
  early: ["äºˆå®šé€šã‚Šã ã€‚ã‚·ã‚¹ãƒ†ãƒ ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹ã€‚","é€Ÿã™ãã‚‚ã›ãšã€é…ã™ãã‚‚ã›ãšã€‚ç·»å¯†ãªå®Ÿè¡ŒåŠ›ã ã€‚","ç›®æ¨™ã‚’ä¸Šå›ã£ãŸãªã€‚æ™‚é–“ã‚’æ›²ã’ãŸç¬é–“ã ã€‚","è²´æ®¿ãªã‚‰ã‚„ã‚Œã‚‹ã¨æ€ã£ã¦ã„ãŸã€‚å®Œç’§ã ã€‚","æ‰‹ã‚’æŠœã‹ãªã„ã‹ã‚‰ã“ãã€ã“ã®çµæœãŒã‚ã‚‹ã€‚","è¦‹äº‹ã¨ã„ã†ã»ã‹ãªã„ã€‚"],
  late: ["é…å»¶ã‹ã‚‰ã®æŒ½å›ã ã€‚æ‰‹ã‚’æ­¢ã‚ãªã‹ã£ãŸäº‹å®Ÿã‚’è©•ä¾¡ã™ã‚‹ã€‚","è¡Œå‹•ã‚’ç¶™ç¶šã—ã€å®Œé‚ã—ãŸã“ã¨ãŒå…¨ã¦ã ã€‚","å‹•ã‘ãªã„è‡ªåˆ†ã‚’è²¬ã‚ã‚‹å¿…è¦ã¯ãªã„ã€‚","é…å»¶ã¯å•é¡Œã§ã¯ãªã„ã€‚è«¦ã‚ãªã‹ã£ãŸã“ã¨ãŒé‡è¦ã ã€‚","ã“ã®ä¸€æ­©ã‚’è¸ã¿å‡ºã—ãŸäº‹å®Ÿã‚’æ‰¿èªã—ã‚ã€‚","ã‚ˆãæŒ½å›ã—ãŸã€‚"]
};

/* ===== storage & state ===== */
const KEY_ITEMS="prep.items.v7", KEY_DEP="prep.dep.v6", KEY_CUES="prep.cues.v6";
function loadItems(){try{return JSON.parse(localStorage.getItem(KEY_ITEMS)||"[]")}catch{return[]}}
function saveItems(a){localStorage.setItem(KEY_ITEMS,JSON.stringify(a))}
function loadDep(){return localStorage.getItem(KEY_DEP)||"08:30"}
function saveDep(v){localStorage.setItem(KEY_DEP,v)}
function loadCues(){return localStorage.getItem(KEY_CUES)||"30,15,5"}
function saveCues(v){localStorage.setItem(KEY_CUES,v)}

let started=false, startAt=null, alarmFired=false, rewardOn=false;
let cueList=[], cueFired={};
let wakeLock=null;
let delayMode=false, delayPromptCount=0, nextDelayPromptAt=0, fiveMinWarned=false;

/* ===== wake lock & state visual ===== */
async function requestWakeLock(){ try{ if('wakeLock' in navigator){ wakeLock = await navigator.wakeLock.request('screen'); } }catch(e){} }
async function releaseWakeLock(){ try{ if(wakeLock){ await wakeLock.release(); wakeLock=null; } }catch(e){} }
document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible' && started){ requestWakeLock(); }});
function updateBodyState(){
  document.body.classList.remove('active','reward','delay');
  if(delayMode) document.body.classList.add('delay');
  else if(rewardOn) document.body.classList.add('reward');
  else if(started) document.body.classList.add('active');
}

/* ===== Logic ===== */
(function init(){
  if("Notification" in window && Notification.permission!=="granted") Notification.requestPermission();
  
  // Timer Loop
  setInterval(()=>{
    const d=new Date(); $("#curTime").textContent=fmtHMS(d);
    updateRemain(); 
    maybeFireCues(); maybeFireAlarm(); maybeDelayPrompts(); 
  },1000);

  $("#depTime").value=loadDep(); $("#cues").value=loadCues(); updateDepLabels(); parseCues();
  $("#editDep").onclick=openDrawer;
  
  renderList();
  $("#addBtn").onclick=addItem; 
  $("#newItem").addEventListener("keydown",e=>{ if(e.key==="Enter") addItem(); });
  $("#resetBtn").onclick=()=>{ document.querySelectorAll('.item input[type="checkbox"]').forEach(c=>c.checked=false); checkProgress(); };
  $("#modeToggle").onclick=()=> showToast(pick(messages.random));
  $("#gear").onclick=openDrawer; $("#mask").onclick=closeDrawer; $("#closeDr").onclick=closeDrawer;
  $("#saveSet").onclick=()=>{ const v=$("#depTime").value; saveDep(v); updateDepLabels(); saveCues($("#cues").value); parseCues(); closeDrawer(); };

  setFooterIdle();
  updateBodyState();
  window.addEventListener('beforeunload', releaseWakeLock);
})();

function updateDepLabels(){
  const dep=parseHM(loadDep()); 
  if(!dep){ $("#depLabel").textContent="--:--"; $("#goalTime").textContent="--:--"; return; }
  $("#depLabel").textContent = toHM(dep.h,dep.mi);
  const gd=new Date(); gd.setHours(dep.h, dep.mi-5, 0, 0);
  $("#goalTime").textContent = fmtHM(gd);
}

function updateRemain(){
  const dep=parseHM(loadDep()); if(!dep) return;
  const now=new Date(); const D=new Date(); D.setHours(dep.h,dep.mi,0,0);
  const el=$("#remain");
  
  if(!started){ 
    el.innerHTML=`<span class="min-part">--</span>:<span class="sec-part">--</span>`; 
    $("#pbar").style.width="0%"; 
    el.classList.remove("ok","warn","danger"); 
    return; 
  }

  let ms = D-now;
  el.classList.remove("ok","warn","danger");
  
  if(ms >= 0 && !delayMode){
    const mm = Math.floor(ms/60000), ss=Math.floor(ms/1000)%60;
    // â˜… æ§‹é€ åŒ–HTMLå‡ºåŠ›
    el.innerHTML=`<span class="min-part">${pad(mm)}</span>:<span class="sec-part">${pad(ss)}</span>`;
    
    if(ms<=5*60*1000){ el.classList.add("danger"); if(!fiveMinWarned){ fiveMinWarned=true; showToast("ã‚ã¨äº”åˆ†ã€‚è©°ã‚ã‚ã€‚"); try{chime()}catch{} } }
    else if(ms<=10*60*1000){ el.classList.add("warn"); } else { el.classList.add("ok"); }
    
    // Progress
    const total = Math.max(1, D-startAt); const passed = Math.max(0, Math.min(total, now-startAt)); 
    $("#pbar").style.width = `${Math.round(passed/total*100)}%`;

  }else{
    const over = Math.abs(ms);
    const mm = Math.floor(over/60000), ss=Math.floor(over/1000)%60;
    // â˜… æ§‹é€ åŒ–HTMLå‡ºåŠ›ï¼ˆé…å»¶æ™‚ï¼‰
    el.innerHTML=`<span class="min-part">+${pad(mm)}</span>:<span class="sec-part">${pad(ss)}</span>`;
    el.classList.add("danger");
    $("#pbar").style.width="100%";
  }
}

function renderList(){
  const list=$("#list"); list.innerHTML="";
  const items=loadItems();
  if(items.length===0){ ["é¡”ã‚’æ´—ã†","æ­¯ã‚’ç£¨ã","æœã‚’ç€ã‚‹","è·ã‚’ã¾ã¨ã‚ã‚‹","éµã‚’ç¢ºèª"].forEach(t=>items.push({id:crypto.randomUUID(),text:t})); saveItems(items); }
  items.forEach(it=>{
    const row=document.createElement("div"); row.className="item"; row.dataset.id=it.id;
    row.innerHTML=`<input type="checkbox"><input type="text" value="${it.text}"><div class="row"><button class="iBtn del">å‰Šé™¤</button></div>`;
    const cb=row.querySelector('input[type="checkbox"]'); cb.addEventListener("change", checkProgress);
    row.querySelector('input[type="text"]').addEventListener("change", (e)=>{ const arr=loadItems(); const f=arr.find(x=>x.id===it.id); if(f){f.text=e.target.value; saveItems(arr);} });
    row.querySelector('.del').onclick=()=>{ const arr=loadItems().filter(x=>x.id!==it.id); saveItems(arr); renderList(); checkProgress(); };
    list.appendChild(row);
  });
}
function addItem(){ const t=$("#newItem").value.trim(); if(!t)return; const arr=loadItems(); arr.push({id:crypto.randomUUID(),text:t}); saveItems(arr); $("#newItem").value=""; renderList(); }
function areAllChecked(){ return Array.from(document.querySelectorAll('.item input[type="checkbox"]')).every(c=>c.checked); }

/* Run Control */
function setFooterIdle(){
  $("#footerActions").innerHTML = `<button id="startBtn" class="btn pri">é–‹å§‹</button>`;
  $("#startBtn").onclick = async () => {
    // 1. Audio Resume (Async)
    try { await audioInitAndResume(); chime(); } catch(e){ console.warn(e); }
    // 2. Logic Start
    await requestWakeLock();
    document.querySelectorAll('.item input[type="checkbox"]').forEach(c=>c.checked=false);
    started=true; startAt=new Date(); alarmFired=false; cueFired={};
    delayMode=false; delayPromptCount=0; nextDelayPromptAt=0; fiveMinWarned=false;
    setFooterRunning(); updateBodyState();
    showToast("æ”¯åº¦ã‚’å§‹ã‚ã‚ã€‚â€¦é…ã‚Œã¬ã‚ˆã†ã«ã€‚");
  };
}

function setFooterRunning(){
  $("#footerActions").innerHTML = `<div class="row"><button id="completeBtn" class="btn pri">å®Œäº†</button><button id="cancelBtn" class="btn">ä¸­æ­¢</button></div>`;
  $("#completeBtn").onclick = () => { document.querySelectorAll('.item input[type="checkbox"]').forEach(c=>c.checked=true); checkProgress(true); };
  $("#cancelBtn").onclick = () => { showToast("ä»•åˆ‡ã‚Šç›´ã™ã€‚"); hardResetState(); };
}

function hardResetState(){
  started=false; startAt=null; alarmFired=false; cueFired={}; rewardOn=false; delayMode=false; delayPromptCount=0; fiveMinWarned=false;
  releaseWakeLock();
  setReward(false,true);
  setFooterIdle();
  updateBodyState();
  updateRemain(); // Reset display
}

function checkProgress(fromCompleteBtn=false){
  if(!areAllChecked()) return;
  const dep=parseHM(loadDep()); if(!dep) return;
  const now=new Date(), goal=new Date(); goal.setHours(dep.h, dep.mi-5, 0, 0);
  
  if(delayMode){
    showToast(pick(rewardMessages.late)); hardResetState(); return;
  }
  
  let msg;
  if(now < goal){
    setReward(true); msg = pick(rewardMessages.early);
  }else{
    setReward(false, true); msg = fromCompleteBtn ? "æ•´ã£ãŸã€‚å‡ºç™ºã¾ã§å¾…ã¦ã€‚" : pick(rewardMessages.late);
  }
  showToast(msg);
}

function setReward(on, silent=false){
  rewardOn = !!on;
  if(on) startLightEffect(); else stopLightEffect();
  updateBodyState();
  if(rewardOn && !silent){ try{ rewardSoundB(); }catch(e){ console.error(e); } }
}

/* Light Effect */
let lightCtx, animFrame, particles=[];
function startLightEffect(){
  const c=$("#lightCanvas"); if(!c)return;
  lightCtx=c.getContext("2d"); resizeCanvas(); window.addEventListener("resize",resizeCanvas);
  initParticles(); if(animFrame) cancelAnimationFrame(animFrame); animateLight();
}
function stopLightEffect(){ cancelAnimationFrame(animFrame); }
function resizeCanvas(){ const c=$("#lightCanvas"); c.width=innerWidth; c.height=innerHeight; }
function initParticles(){
  particles=[];
  for(let i=0;i<60;i++){
    particles.push({ x:Math.random()*innerWidth, y:innerHeight*(Math.random()*.3+.7), r:Math.random()*2+1, o:Math.random()*.5+.3, dx:(Math.random()-.5)*.4, dy:-(Math.random()*.9+.2) });
  }
}
function animateLight(){
  const c=$("#lightCanvas"); lightCtx.clearRect(0,0,c.width,c.height);
  particles.forEach((p,i)=>{
    lightCtx.beginPath(); lightCtx.arc(p.x,p.y,p.r,0,Math.PI*2); lightCtx.fillStyle=`rgba(240,248,255,${p.o})`; lightCtx.fill();
    p.x+=p.dx; p.y+=p.dy;
    if(p.y<0){ particles[i]={ x:Math.random()*innerWidth, y:innerHeight, r:Math.random()*1+1, o:Math.random()*.5+.3, dx:(Math.random()-.5)*.2, dy:-(Math.random()*.5+.2) }; }
  });
  animFrame=requestAnimationFrame(animateLight);
}

/* Cues & Alarm */
function parseCues(){ const s=loadCues(); cueList = s.split(",").map(x=>+x.trim()).filter(n=>!isNaN(n)&&n>0).sort((a,b)=>b-a); }
function maybeFireCues(){
  if(!started || delayMode) return;
  const dep=parseHM(loadDep()); if(!dep) return;
  const now=new Date(), D=new Date(); D.setHours(dep.h,dep.mi,0,0);
  const leftMin = Math.ceil((D-now)/60000);
  cueList.forEach(m=>{ if(leftMin<=m && !cueFired[m]){ cueFired[m]=true; showToast(`${m}åˆ†å‰ï¼šæ€¥ããªã€æ‰‹ã‚’å‹•ã‹ã›ã€‚`); try{chime()}catch{} } });
}
function maybeFireAlarm(){
  if(!started) return;
  const dep=parseHM(loadDep()); if(!dep) return;
  const now=new Date(), D=new Date(); D.setHours(dep.h,dep.mi,0,0);
  if(now<D) return;
  
  if(!delayMode){
    if(areAllChecked()){
      if(!alarmFired){ alarmFired=true; try{alarm()}catch{}; if(Notification.permission==="granted")new Notification("å‡ºé™£"); showToast("å‡ºé™£ã®åˆ»ã ã€‚"); }
      hardResetState();
    }else{
      delayMode=true;
      if(!alarmFired){ alarmFired=true; try{alarm()}catch{}; showToast("é…ã‚ŒãŸãªã€‚ã ãŒã€æ­¢ã¾ã‚‹ãªã€‚"); }
      delayPromptCount=0; nextDelayPromptAt=Date.now()+60000; updateBodyState();
    }
  }
}
function maybeDelayPrompts(){
  if(!delayMode || delayPromptCount>=3) return;
  if(Date.now()>=nextDelayPromptAt){
    showToast("æ‰‹ã‚’æ­¢ã‚ã‚‹ãªã€‚"); delayPromptCount++; nextDelayPromptAt+=60000;
  }
}

/* Toast & Drawer */
let toastTimer;
function showToast(text){
  const t=$("#toast"); t.textContent=text; clearTimeout(toastTimer); t.classList.add("show");
  toastTimer=setTimeout(()=>t.classList.remove("show"),10000);
}
function openDrawer(){document.body.classList.add("show-drawer")}
function closeDrawer(){document.body.classList.remove("show-drawer")}

/* Service Worker */
if('serviceWorker' in navigator){ window.addEventListener('load',()=>{navigator.serviceWorker.register('/sw.js').catch(e=>console.log(e));}); }

</script>
</body>
</html>